# Cat-SetImage.ps1
# Powershell to automatically update Master Image from XenDesktop Catalog
# CC-BY-SA Joaquin Herrero 2017 (@joakinen)
# https://creativecommons.org/licenses/by-sa/4.0/
#
# Check https://support.citrix.com/article/CTX129205 for more information
#

# Syntax
#    Cat-SetImage -scheme <scheme-name> [-snapshot <snapshot_name> ]
#
# Explanation
#    This power shell script updates a XenDesktop Catalog (Scheme) with the last snapshot available
#    from the machine acting as Master Image or with the selected snapshot.
#    Optionally it cal only list all the snapshots available

param(
[switch]$list,

[Parameter(Mandatory=$true, HelpMessage="Type name of scheme you are provisioning")]
[string] $scheme = "", 

[string] $snapshot = ""

)


if ( $snapshot -and !($snapshot -match "(?<cleanSnapshot>.*).snapshot") ) {
		$snapshot = $snapshot + ".snapshot"
	}

Add-PSSnapIn citrix*

if ( $scheme -eq "" ) {
	Write-Host "Error: missing mandatory parameter"
	return
	}

Write-Host "Getting Provisioning Schemes..."
$Schemes = Get-ProvScheme

$found = $false;
foreach ( $thiscat in $Schemes ) {
	$thisScheme = $($thiscat.ProvisioningSchemeName)
	if ( $thisScheme -eq $scheme ) {
		$found = $true;
		$vmPath = "$($thiscat.MasterImageVM)"
	}
}

if ( $found -eq $false ) {
	Write-Host "Error: Scheme $scheme not found."
	return
	} else {
	Write-Host "Scheme found!"
	}

if ( $vmPath -match "(?<cleanVMpath>.*).vm" )
      {
         $vmName = $matches['cleanVMpath'] + ".vm"
      } else {
 	 Write-Host "Error: no .vm found in MasterImageVM field"
	 return
      }
Write-Host "MasterImageVM $vmName found!"

Write-Host "Getting Snapshots..."
$snapshots = Get-ChildItem -Recurse -Path "$vmName" 

$selected_snapshot = "none"
foreach ( $this_snapshot in $snapshots ) {
	if ($snapshot) {
		if ($snapshot -eq $this_snapshot) {
			$selected_snapshot = $($this_snapshot.FullPath)
		}
	} else {	
        if ( $list ) {
            Write-Host ($($this_snapshot))
        } else {
		    $selected_snapshot = $($this_snapshot.FullPath)
        }
	}
} 

if ($list) { return }

if ( $snapshot -and $selected_snapshot -eq "none" ) {
	Write-Host "Error: Snapshot $snapshot not found."
	return
	}

#Write-Host $last_snapshot

$templatePSPath = $selected_snapshot

Write-Host "Provisioning Scheme $scheme with Master Image $templatePSPath..."
Publish-ProvMasterVmImage -ProvisioningSchemeName "$scheme" -MasterImageVM "$templatePSPath"
